{% extends 'layout.html' %}
{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <h2 class="display-4">Distributed System Health</h2>
        <p class="lead">Monitor and visualize system health metrics to ensure availability, detect failures, and analyze overall system performance for DistSales.</p>
    </div>

    <div class="row">
        <div class="col-md-6 mb-4">
            <h5>Leader Identity</h5>
            <span id="leaderName" class="badge bg-primary">Loading...</span>
        </div>
        <div class="col-md-6 mb-4">
            <div class="dashboard-row">
                <div class="d-flex flex-row flex-wrap gap-4 justify-content-start align-items-stretch" style="width:100%">
                    <div class="mb-3" style="min-width:180px;max-width:220px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="display:inline-block;width:28px;height:20px;background:#2dce89;border-radius:6px;"></span>
                            <span style="font-size:1em;">Connected</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                            <span style="display:inline-block;width:28px;height:20px;background:#d1d5db;border-radius:6px;"></span>
                            <span style="font-size:1em;">Disconnected</span>
                        </div>
                    </div>
                    <div id="clients-row" class="d-flex flex-row flex-wrap gap-4 justify-content-start align-items-stretch" style="flex:1 1 0%;"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <h5>Replication Lag</h5>
            <canvas id="chart3"></canvas>
        </div>
        <div class="col-md-6 mb-4">
            <h5>Client-Side Latency</h5>
            <canvas id="chart4"></canvas>
        </div>
    </div>
    <div class="mt-4 text-start">
        <h5>Activity Logs</h5>
        <ul id="log-list"></ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let rawData = '{{ data | tojson | safe }}';
    let initialData = JSON.parse(rawData);

    function getLabelsAndCounts(data) {
        return {
            labels: data.map(entry => entry.time),
            counts: data.map(entry => entry.count)
        };
    }

    function createChart(ctxId, label, color) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        const { labels, counts } = getLabelsAndCounts(initialData);

        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: counts,
                    borderColor: color,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { precision: 0 }
                    }
                }
            }
        });
    }

    const chart3 = createChart('chart3', 'Third Metric', 'rgb(54, 162, 235)');
    const chart4 = createChart('chart4', 'Fourth Metric', 'rgb(255, 206, 86)');

    async function updateCharts() {
        const res = await fetch('/data');
        const data = await res.json();
        const { labels, counts } = getLabelsAndCounts(data);

        [chart3, chart4].forEach(chart => {
            chart.data.labels = labels;
            chart.data.datasets[0].data = counts;
            chart.update();
        });
    }

    async function updateClusterStatus() {
        try {
            const res = await fetch('/cluster_status');
            const data = await res.json();

            // Update leader badge
            const leaderEl = document.getElementById('leaderName');
            leaderEl.textContent = data.leader;
            leaderEl.className = 'dashboard-badge leader-badge';

            // Display all clients in a row, same color, side by side
            const clientsRow = document.getElementById('clients-row');
            clientsRow.innerHTML = '';
            data.clients.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.style.minWidth = '270px';
                clientDiv.style.maxWidth = '320px';
                clientDiv.style.marginBottom = '0';
                clientDiv.style.display = 'flex';
                clientDiv.style.flexDirection = 'column';
                clientDiv.style.alignItems = 'center';
                clientDiv.style.justifyContent = 'center';
                clientDiv.style.padding = '18px 10px 12px 10px';
                clientDiv.style.borderRadius = '14px';
                clientDiv.style.background = client.last_disconnected === 'N/A' ? '#2dce89' : '#d1d5db';
                clientDiv.style.color = client.last_disconnected === 'N/A' ? '#fff' : '#888';
                clientDiv.style.boxShadow = '0 2px 12px rgba(0,0,0,0.04)';
                clientDiv.style.fontWeight = '500';
                clientDiv.style.fontSize = '1.2em';
                clientDiv.style.transition = 'background 0.3s';
                clientDiv.style.marginRight = '0';
                clientDiv.style.marginLeft = '0';
                clientDiv.innerHTML = `
                    <div style="word-break:break-all;">${client.client}</div>
                    <div style="font-size:0.95em; color:#a7f3d0;">Connected: ${client.last_connected || 'N/A'}</div>
                    <div style="font-size:0.95em; color:#fecaca;">Disconnected: ${client.last_disconnected || 'N/A'}</div>
                `;
                clientsRow.appendChild(clientDiv);
            });
        } catch (err) {
            console.error("Failed to fetch cluster status:", err);
        }
    }

    async function fetchLogs() {
        const res = await fetch("/logs");
        const data = await res.json();
        document.getElementById("log-list").innerHTML = data.map(log => `<p>${log.time} - ${log.event}</p>`).join("");
    }

    setInterval(() => {
        updateCharts();
        updateClusterStatus();
        fetchLogs();
    }, 1000);
    setInterval(fetchLogs, 2000);
</script>
{% endblock %}